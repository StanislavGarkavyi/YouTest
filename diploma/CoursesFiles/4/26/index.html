<p>Создадим приложение на ASP.NET Core в связке с Angular, которое будет реализовать простейший CRUD интерфейс, то есть выполнять базовые опреации по чтению, добавлению, изменению и удалению данных. За основу возьмем проект из прошлой темы:</p>
<img src="../../CoursesFiles/4/26/img/1.jpg" style="width: 30%">
<p><b>Сервис Web API</b></p>
<p>Вначале определим логику на стороне сервера. Для этого создадим в проекте новую папку Models, которая будет содержать модели. Затем добавим в нее класс Product:</p>
<img src="../../CoursesFiles/4/26/img/2.jpg">
<p>Данный класс представляет данные о товарах, которые будут храниться в базе данных. Для работы с БД добавим в папку Models класс контекста данных ApplicationContext:</p>
<img src="../../CoursesFiles/4/26/img/3.jpg">
<p>Далее определим собственно ту логику, которая будет выполняться на сервере. Добавим в проект папку Controllers. Затем в этой папке определим класс контроллера ProductsController:</p>
<br><img src="../../CoursesFiles/4/26/img/5.jpg"><br><img src="../../CoursesFiles/4/26/img/6.jpg"><br><img src="../../CoursesFiles/4/26/img/7.jpg"><br>
<p>Контроллер получает через конструктор констект данных и через него производит различные операции с данными из БД.</p>
<p>И изменим файл Startup.cs:</p>
<br><img src="../../CoursesFiles/4/26/img/8.jpg"><br><img src="../../CoursesFiles/4/26/img/9.jpg">
<p>Для работ с контроллером здесь добавляется поддержка фреймворка MVC. И также регистрируется контекст данных как сервис.</p>
<p>После этого можно создать и выполнить миграции, последовательно введя в Visual Studio в окно Package Manager Console следующие команды:</p>
<img src="../../CoursesFiles/4/26/img/10.jpg">
<p><b>Модель данных</b></p>
<p>После создания серверной части изменим клиентскую часть. В проекте в папке ClientApp/app создадим файл product.ts:</p>
<img src="../../CoursesFiles/4/26/img/11.jpg">
<p>Этот класс аналогичен модели Product, которая используется на стороне сервера, и будет представлять используемые данные.</p>
<p><b>Создание http-сервиса</b></p>
<p>Также в папку ClientApp/app добавим новый файл data.service.ts:</p>
<br><img src="../../CoursesFiles/4/26/img/12.jpg"><br><img src="../../CoursesFiles/4/26/img/13.jpg"><br>
<p>Здесь определен сервис, через который клиент будет взаимодействовать с сервером. Чтобы его можно было внедрять в другие классы, к этому сервису применяется декоратор @Injectable.</p>
<p>Сервис определяет четыре метода для отправки данных на сервер различным методам контроллера ProductController. Поскольку этот контроллер будет запускаться по адресу "/api/products", то соответственно по этому адресу будут отправляться запросы. Для отправки запросов используется класс HttpClient из пакета @angular/common/http.</p>
<p>Чтобы получить все данные с сервера, выполняется метод getProducts:</p>
<img src="../../CoursesFiles/4/26/img/14.jpg">
<p>Здесь вызывается метод get объекта HttpClient, в который передается адрес сервера.</p>
<p>В методе createProduct() отправляем новый объект Product на сервер.</p>
<img src="../../CoursesFiles/4/26/img/15.jpg">
<p>Метод updateProduct() получает через параметр измененный объект и отправляет его на сервер с помощью метода put класса HttpClient:</p>
<img src="../../CoursesFiles/4/26/img/16.jpg">
<p>В метод put также передается адрес и отправляемый объект.</p>
<p>И в методе deleteProduct() производится удаление объекта по id:</p>
<img src="../../CoursesFiles/4/26/img/17.jpg">
<p><b>Создание компонента</b></p>
<p>Используем этот сервис. Для этого определим в папке ClientApp/app следующий файл app.component.ts:</p>
<br><img src="../../CoursesFiles/4/26/img/18.jpg"><br><img src="../../CoursesFiles/4/26/img/19.jpg"><br><img src="../../CoursesFiles/4/26/img/20.jpg"><br>
<p>Для использования сервис DataService добавляется в свойстве providers. И затем мы сможем получить этот сервис через конструктор класса AppComponent.</p>
<p>Класс компонента определяет три переменных. Переменная product представляет товар, который будет добавляться или редактироваться. Переменная tableMode представляет логическое значение, которое указывает, находимся ли мы в процессе добавления нового объекта или в процессе просмотра всех объектов в виде таблицы. А переменнаяproducts хранит все полученные с сервера данные.</p>
<p>В методе OnInit(), который выполняется при запуске компонента, будет выполняться начальная загрузка данных. Сама загрузка данных производится в методе loadProducts(). Здесь идет обращение к методу getProducts, который определен в сервисе. Запрос фактически выполняется после вызова функции subscribe(), в которой через параметр стрелочной функции получаем данные и передаем эти данные переменной products.</p>
<p>Метод save() сохраняет объект. Если id объекта не установлен, то мы имеем дело с добавлением нового объекта. В зависимости от того, что происходит - добавление или изменение вызывается определенный метод сервиса. Полученный с сервера при добавлении объект затем добавляется в массив products. При редактировании просто перезагружаем данные.</p>
<p>Метод editProduct() устанавливает редактируемый объект.</p>
<p>Метод cancel() сбрасывает состояние к начальному.</p>
<p>Метод delete() удаляет объект, вызывая соответствующий метод сервиса.</p>
<p>Метод add() изменяем режим и фактически переключает пользователя с просмотра объектов в виде таблицы на добавление нового объекта.</p>
<p><b>Создание представления</b></p>
<p>Класс AppComponent для определения визуальной части использует файл app.component.html. Определим этот файл в папке ClientApp/app и определим в нем следующее содержимое:</p>
<br><img src="../../CoursesFiles/4/26/img/21.jpg"><br><img src="../../CoursesFiles/4/26/img/22.jpg"><br><img src="../../CoursesFiles/4/26/img/23.jpg"><br><img src="../../CoursesFiles/4/26/img/24.jpg"><br>
<p>В начале разметки определена кнопка, которая переключает режим страницы с просмотра данных на их добавление. Затем собственно идет таблица с данными. Причем таблица использует директиву *ngIf="tableMode; else create", то есть если tableMode равна true, то отображается данный элемент table. Иначе вместо элемента table отображается разметка шаблона create, который определен в конце файла. Шаблон create содержит набор полей для ввода данных объекта Product. То есть с помощью кнопки мы можем переключаться с элемента table на шаблон create и обратно.</p>
<p>В таблице выводятся все данные, возвращаемые геттером products. При этом для каждой строки используется определенный шаблон:</p>
<img src="../../CoursesFiles/4/26/img/25.jpg">
<p>То есть если id объекта из переменной product НЕ равен id текущему объекту, то просто выводим данные. Если id обоих объектов равны, то вместо этого шаблона применяется шаблон edit, который определен в конце файла.</p>
<p>В какой ситуации id объектов будут равны? Для каждой строки определены две кнопки - для удаления и изменения. При нажатии на кнопку изменения переменной product передается тот объект, который мы хотим изменить. А это значит что id у данного объекта из таблицы равно id объекта из переменной product, поэтому для данного объекта применяется шаблон edit, который содержит поля для редактирования.</p>
<p><b>Изменение модуля</b></p>
<p>Чтобы взаимодействие с сервером заработало, изменим в папке ClientApp/app файл app.module.ts следующим образом:</p>
<img src="../../CoursesFiles/4/26/img/26.jpg">
<p>Для выполнения запросов и работы с http здесь импортируется модуль HttpClientModule.</p>
<p>В итоге весь проект будет выглядеть следующим образом:</p>
<img src="../../CoursesFiles/4/26/img/27.jpg" style="width: 30%">
<p>Запустим проект, и мы увидим таблицу с данными:</p>
<img src="../../CoursesFiles/4/26/img/28.jpg">
<p>Если мы нажмем на кнопку изменения, то строка перейдет в режим редактирования:</p>
<img src="../../CoursesFiles/4/26/img/29.jpg">
<p>При нажатии на кнопку добавления мы перейдем к форме добавления нового объекта:</p>
<img src="../../CoursesFiles/4/26/img/30.jpg">
<style>p{text-indent: 25px}img{width: 100%}</style>